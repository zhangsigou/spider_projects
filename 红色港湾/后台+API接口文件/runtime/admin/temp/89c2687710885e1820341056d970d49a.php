<?php /*a:3:{s:60:"/www/wwwroot/hong.linyiit.cn/app/admin/view/queue/index.html";i:1605948572;s:53:"/www/wwwroot/hong.linyiit.cn/app/admin/view/main.html";i:1605948572;s:67:"/www/wwwroot/hong.linyiit.cn/app/admin/view/queue/index_search.html";i:1605948572;}*/ ?>
<div class="layui-card layui-bg-gray"><?php if(!(empty($title) || (($title instanceof \think\Collection || $title instanceof \think\Paginator ) && $title->isEmpty()))): ?><div class="layui-card-header notselect"><span class="layui-icon layui-icon-next font-s10 color-desc margin-right-5"></span><?php echo htmlentities((isset($title) && ($title !== '')?$title:'')); ?><div class="pull-right"><!--<?php if(auth("start") && $iswin): ?>--><button data-load='<?php echo url("start"); ?>' class='layui-btn layui-btn-sm layui-btn-primary'>开始监听</button><!--<?php endif; ?>--><!--<?php if(auth("stop") && $iswin): ?>--><button data-load='<?php echo url("stop"); ?>' data-confirm="确定要停止主进程监听吗？" class='layui-btn layui-btn-sm layui-btn-primary'>停止监听</button><!--<?php endif; ?>--><!--<?php if(auth("remove")): ?>--><button data-action='<?php echo url("remove"); ?>' data-rule="id#{key}" data-confirm="确定批量删除任务吗？" class='layui-btn layui-btn-sm layui-btn-primary'>批量删除</button><!--<?php endif; ?>--><!--<?php if(auth("clear")): ?>--><button data-load='<?php echo url("clear"); ?>' data-confirm="确定要创建定时清理任务吗？" class='layui-btn layui-btn-sm layui-btn-primary'>定时清理</button><!--<?php endif; ?>--></div></div><?php endif; ?><div class="layui-card-body"><div class="think-box-shadow table-block"><div class="layui-row layui-col-space20 portal-block-container notselect"><div class="layui-col-sm6 layui-col-md6 layui-col-lg3"><div class="portal-block-item nowrap" style="background:linear-gradient(-125deg,#57bdbf,#2f9de2)"><div>待处理</div><div><?php echo htmlentities((isset($total['pre']) && ($total['pre'] !== '')?$total['pre']:0)); ?></div><div>待处理的任务数量</div></div><i class="portal-block-icon layui-icon layui-icon-star"></i></div><div class="layui-col-sm6 layui-col-md6 layui-col-lg3"><div class="portal-block-item nowrap" style="background:linear-gradient(-125deg,#ff7d7d,#fb2c95)"><div>处理中</div><div><?php echo htmlentities((isset($total['dos']) && ($total['dos'] !== '')?$total['dos']:0)); ?></div><div>处理中的任务数量</div></div><i class="portal-block-icon layui-icon layui-icon-log"></i></div><div class="layui-col-sm6 layui-col-md6 layui-col-lg3"><div class="portal-block-item nowrap" style="background:linear-gradient(-113deg,#c543d8,#925cc3)"><div>处理完成</div><div><?php echo htmlentities((isset($total['oks']) && ($total['oks'] !== '')?$total['oks']:0)); ?></div><div>处理完成的任务数量</div></div><i class="portal-block-icon layui-icon layui-icon-release"></i></div><div class="layui-col-sm6 layui-col-md6 layui-col-lg3"><div class="portal-block-item nowrap" style="background:linear-gradient(-141deg,#ecca1b,#f39526)"><div>处理失败</div><div><?php echo htmlentities((isset($total['ers']) && ($total['ers'] !== '')?$total['ers']:0)); ?></div><div>处理失败的任务数量</div></div><i class="portal-block-icon layui-icon layui-icon-engine"></i></div></div><?php if(session('user.username') == 'admin'): ?><fieldset class="margin-bottom-15"><legend class="notselect">守护状态</legend><div class="layui-code border-0 margin-top-0"><h4 class="color-desc margin-top-10 notselect">守护进程运行状态</h4><div data-queue-message>Checking task process running status ...</div><h4 class="color-desc margin-top-10 notselect">配置定时任务来检查并启动进程（建议每分钟执行）</h4><p><?php echo htmlentities((isset($command) && ($command !== '')?$command:'--')); ?></p></div><script>$('[data-queue-message]').load('<?php echo url("@admin/api.plugs/queue"); ?>')</script></fieldset><?php endif; ?><fieldset><legend>条件搜索</legend><form class="layui-form layui-form-pane form-search" action="<?php echo request()->url(); ?>" onsubmit="return false" method="get" autocomplete="off"><div class="layui-form-item layui-inline"><label class="layui-form-label">任务编号</label><label class="layui-input-inline"><input name="code" value="<?php echo input('get.code'); ?>" placeholder="请输入任务编号" class="layui-input"></label></div><div class="layui-form-item layui-inline"><label class="layui-form-label">任务名称</label><label class="layui-input-inline"><input name="title" value="<?php echo input('get.title'); ?>" placeholder="请输入任务名称" class="layui-input"></label></div><div class="layui-form-item layui-inline"><label class="layui-form-label">任务指令</label><label class="layui-input-inline"><input name="command" value="<?php echo input('get.command'); ?>" placeholder="请输入任务指令" class="layui-input"></label></div><div class="layui-form-item layui-inline"><label class="layui-form-label">任务状态</label><label class="layui-input-inline"><select name="status" class="layui-select"><?php foreach([''=>'-- 全部状态 --','1'=>'等待处理','2'=>'正在处理','3'=>'处理完成','4'=>'处理失败'] as $k=>$v): if(input('get.status') == $k): ?><option selected value="<?php echo htmlentities($k); ?>"><?php echo htmlentities($v); ?></option><?php else: ?><option value="<?php echo htmlentities($k); ?>"><?php echo htmlentities($v); ?></option><?php endif; ?><?php endforeach; ?></select></label></div><div class="layui-form-item layui-inline"><label class="layui-form-label">计划时间</label><label class="layui-input-inline"><input data-date-range name="exec_time" value="<?php echo input('get.exec_time'); ?>" placeholder="请选择计划时间" class="layui-input"></label></div><div class="layui-form-item layui-inline"><label class="layui-form-label">执行时间</label><label class="layui-input-inline"><input data-date-range name="enter_time" value="<?php echo input('get.enter_time'); ?>" placeholder="请选择执行时间" class="layui-input"></label></div><div class="layui-form-item layui-inline"><label class="layui-form-label">创建时间</label><label class="layui-input-inline"><input data-date-range name="create_at" value="<?php echo input('get.create_at'); ?>" placeholder="请选择创建时间" class="layui-input"></label></div><div class="layui-form-item layui-inline"><button class="layui-btn layui-btn-primary"><i class="layui-icon">&#xe615;</i> 搜 索</button></div></form></fieldset><script>form.render()</script><table class="layui-table" lay-skin="line"><?php if(!(empty($list) || (($list instanceof \think\Collection || $list instanceof \think\Paginator ) && $list->isEmpty()))): ?><thead><tr><th class='list-table-check-td think-checkbox'><label><input data-auto-none data-check-target='.list-check-box' type='checkbox'></label></th><th class='text-left nowrap'>任务信息</th><th class='text-left nowrap'>任务时间</th><th class='text-left nowrap'>任务状态</th></tr></thead><?php endif; ?><tbody><?php foreach($list as $key=>$vo): ?><tr><td class='list-table-check-td think-checkbox'><label><input class="list-check-box" value='<?php echo htmlentities($vo['id']); ?>' type='checkbox'></label></td><td class='text-left nowrap'>
                任务编号：<?php echo htmlentities((isset($vo['code']) && ($vo['code'] !== '')?$vo['code']:'')); ?><br>
                任务名称：<?php echo htmlentities((isset($vo['title']) && ($vo['title'] !== '')?$vo['title']:'')); ?><br>
                任务指令：<?php echo htmlentities((isset($vo['command']) && ($vo['command'] !== '')?$vo['command']:'')); ?></td><td class='text-left nowrap'>
                计划时间：<?php echo htmlentities(format_datetime($vo['exec_time'])); if(isset($vo['exec_pid']) and $vo['exec_pid']>0): ?>（ 进程 <b class="color-blue"><?php echo htmlentities((isset($vo['exec_pid']) && ($vo['exec_pid'] !== '')?$vo['exec_pid']:'-')); ?></b> ）<?php endif; ?><br><?php if($vo['enter_time']>0 and $vo['outer_time']>0): ?> 执行时间：<?php echo htmlentities(format_datetime($vo['enter_time'])); ?>（ 耗时 <b class="color-blue"><?php echo sprintf("%.4f",$vo['outer_time']-$vo['enter_time']); ?></b> 秒 ）<?php elseif($vo['status'] == 2): ?> 执行时间：<?php echo htmlentities(format_datetime($vo['enter_time'])); ?>（ 任务执行中 ）<?php else: ?>执行时间：<span class="color-desc">任务还没有执行，等待执行...</span><?php endif; ?><br>
                创建时间：<?php echo htmlentities(format_datetime($vo['create_at'])); if(isset($vo['loops_time']) and $vo['loops_time'] > 0): ?>（ 每 <b class="color-blue"><?php echo htmlentities((isset($vo['loops_time']) && ($vo['loops_time'] !== '')?$vo['loops_time']:'0')); ?></b> 秒执行，共 <b class="color-blue"><?php echo htmlentities($vo['attempts']); ?></b> 次）<?php else: ?>（ 共执行 <b class="color-blue"><?php echo htmlentities($vo['attempts']); ?></b> 次 ） <?php endif; ?></td><td class='text-left nowrap'><div class="margin-bottom-5"><!--<?php if(isset($vo['loops_time']) and $vo['loops_time'] > 0): ?>--><span class="layui-badge layui-bg-orange">循</span><!--<?php endif; ?>--><!--<?php if($vo['rscript'] == 1): ?>--><span class="layui-badge layui-bg-green">复</span><!--<?php else: ?>--><span class="layui-badge layui-bg-blue">单</span><!--<?php endif; ?>--><!--<?php if($vo['status'] == 1): ?>--><span class="layui-badge layui-bg-black">等待处理</span><!--<?php elseif($vo['status'] == 2): ?>--><span class="layui-badge layui-bg-green">正在处理</span><!--<?php elseif($vo['status'] == 3): ?>--><span class="layui-badge layui-bg-blue">处理完成</span><!--<?php elseif($vo['status'] == 4 and auth('redo')): ?>--><span class="layui-badge layui-bg-red">处理失败</span><a class="layui-badge layui-bg-green" data-confirm="确定要重置该任务吗？" data-queue="<?php echo url('redo'); ?>?code=<?php echo htmlentities($vo['code']); ?>"><i class="layui-icon font-s12">&#xe669;</i></a><!--<?php endif; ?>--><!--<?php if(auth("remove")): ?>--><a class='layui-badge layui-bg-red' data-confirm="确定要删除该任务吗？" data-action='<?php echo url("remove"); ?>' data-value="id#<?php echo htmlentities($vo['id']); ?>"><i class="layui-icon font-s12">&#xe640;</i></a><!--<?php endif; ?>--><a class='layui-badge layui-bg-orange' onclick="$.loadQueue('<?php echo htmlentities($vo['code']); ?>',false)"><i class="layui-icon font-s12">&#xe705;</i></a></div><div class="color-desc"><?php echo (isset($vo['exec_desc']) && ($vo['exec_desc'] !== '')?$vo['exec_desc']:"没有获取到状态描述"); ?></div></td></tr><?php endforeach; ?></tbody></table><?php if(empty($list) || (($list instanceof \think\Collection || $list instanceof \think\Paginator ) && $list->isEmpty())): ?><span class="notdata">没有记录哦</span><?php else: ?><?php echo (isset($pagehtml) && ($pagehtml !== '')?$pagehtml:''); ?><?php endif; ?></div></div></div>